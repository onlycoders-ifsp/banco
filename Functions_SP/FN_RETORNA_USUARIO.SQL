CREATE OR REPLACE FUNCTION FN_RETORNA_USUARIO(P_ID_USUARIO UUID DEFAULT NULL)
RETURNS SETOF RECORD AS $$
DECLARE
BEGIN
		RETURN QUERY SELECT U.NOME, U.CPF, U.EMAIL, U.SEXO, 
		(SELECT COUNT(1)FROM PRODUTOS PP WHERE U.ID_USUARIO = PP.ID_USUARIO) PRODUTOS_CADASTRADOS,
		T.TELEFONE, T.CELULAR, U.DATA_INCLUSAO
		FROM USUARIOS U
		LEFT JOIN TELEFONES T
		ON T.ID_USUARIO = U.ID_USUARIO
		WHERE (U.ID_USUARIO = P_ID_USUARIO OR P_ID_USUARIO IS NULL);
		
		EXCEPTION WHEN OTHERS THEN
			PERFORM FN_REPORT_ERRO('ERRO AO SELECIONA USUARIO', SQLSTATE, SQLERRM);
	RETURN;
END;
$$ LANGUAGE PLPGSQL;

/* SEM PARAMENTRO RETORNA TUDO
SELECT *FROM FN_RETORNA_USUARIO('8e7578b4-79dd-47f7-9c80-b0b7917166ab') -- OU SELECT *FROM FN_RETORNA_USUARIO()
			AS T(NOME TEXT, CPF VARCHAR(14), LOGRADOURO TEXT, NUMERO VARCHAR(10), CEP VARCHAR(10), 
				 EMAIL VARCHAR(50), SEXO TEXT, QTD_PRODUTOS BIGINT, 
				 TELEFONE VARCHAR(20), CELULAR VARCHAR(20), DATA_INCLUSAO TIMESTAMPTZ);
*/