/*************************************************************
Função/Procedimento: FN_INSERIR_USUARIO.
Objetivo: Responsável pelo cadastro das informações de usuário.
Parâmetros: Nome, CPF, Logradouro, Numero, CEP, Email, Sexo, Data_Nascimento, Senha, Telefone(null), Celular(null).
Exemplo de execução:
START TRANSACTION;
SELECT FN_INSERIR_USUARIO('Mais um pra confirmar', '1122334466', 'Testando', '123', '1234567890', 
						  'testedebancov3@alugo.com', 2, '2020-06-05', 
						  'aaabbbccc', '123456780', '12345678911')
COMMIT;
**************************************************************/

CREATE OR REPLACE FUNCTION FN_INSERIR_USUARIO(P_NOME TEXT, P_CPF VARCHAR(14), P_LOGRADOURO TEXT, P_NUMERO VARCHAR(10), 
								P_CEP CHAR(10), P_EMAIL VARCHAR(50), P_SEXO VARCHAR(50), P_NASCIMENTO TEXT, 
								P_SENHA TEXT, P_LOGIN VARCHAR(50) DEFAULT NULL, P_TELEFONE VARCHAR(20) DEFAULT NULL, P_CELULAR VARCHAR(20) DEFAULT NULL)
RETURNS BOOLEAN AS $$
DECLARE P_ID_USUARIO UUID;
DECLARE OK BOOLEAN = FALSE;
DECLARE P_DATA_NASCIMENTO DATE;
BEGIN
	
	P_DATA_NASCIMENTO := TO_DATE(P_NASCIMENTO, 'YYYY-MM-DD');
	
	/*
	SELECT FN_GET_ID_SEXO(P_SEXO) INTO P_ID_SEXO;
	
	IF P_ID_SEXO IS NULL THEN
		RAISE INFO 'NÃO FOI ENCONTRADO O SEXO';
		RETURN FALSE;
	END IF;
	*/
	
	BEGIN
		INSERT INTO USUARIOS(
		NOME,
		CPF,
		LOGRADOURO,
		NUMERO,
		CEP,
		EMAIL,
		SEXO,
		DATA_NASCIMENTO)
		VALUES(
		P_NOME,
		P_CPF,
		P_LOGRADOURO,
		P_NUMERO,
		P_CEP,
		P_EMAIL,
		P_SEXO,
		P_DATA_NASCIMENTO)
		RETURNING ID_USUARIO INTO P_ID_USUARIO;
	
		EXCEPTION WHEN OTHERS THEN
			PERFORM FN_REPORT_ERRO('ERRO AO INSERIR O USUARIO', sqlstate, sqlerrm);
			RETURN FALSE;
	END;
	
	IF P_LOGIN IS NULL THEN
		P_LOGIN := P_EMAIL;
	END IF;
		
	SELECT FN_INSERIR_LOGIN(P_ID_USUARIO, P_SENHA, P_LOGIN) INTO OK;
	
	IF OK = FALSE THEN
		RETURN FALSE;
	END IF;
	
	SELECT FN_INSERIR_TELEFONES(P_ID_USUARIO, P_TELEFONE, P_CELULAR) INTO OK;
	
	IF OK THEN
		RETURN TRUE;
	ELSE
		RETURN FALSE;
	END IF;
END;
$$  LANGUAGE PLPGSQL