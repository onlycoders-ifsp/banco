CREATE OR REPLACE FUNCTION FN_RETORNA_TODOS_USUARIOS()
RETURNS SETOF RECORD AS $$
DECLARE
BEGIN
		RETURN QUERY SELECT U.NOME, U.CPF, U.LOGRADOURO, U.NUMERO, U.CEP, U.EMAIL, S.DESCRICAO, 
		(SELECT COUNT(1)FROM PRODUTOS PP WHERE U.ID_USUARIO = PP.ID_USUARIO) PRODUTOS_CADASTRADOS,
		T.TELEFONE, T.CELULAR, U.DATA_INCLUSAO
		FROM USUARIOS U
		INNER JOIN SEXO S 
		ON U.ID_SEXO = S.ID_SEXO
		INNER JOIN TELEFONES T
		ON T.ID_USUARIO = U.ID_USUARIO
		LEFT JOIN PRODUTOS P
		ON U.ID_USUARIO = P.ID_USUARIO;

		EXCEPTION WHEN OTHERS THEN
			PERFORM FN_REPORT_ERRO('ERRO AO SELECIONAR USUARIOS', sqlstate, sqlerrm);
		
	RETURN;
END;
$$  LANGUAGE PLPGSQL

/*
SELECT *FROM FN_RETORNA_TODOS_USUARIOS()
			AS T(NOME TEXT, CPF VARCHAR(14), LOGRADOURO TEXT, NUMERO VARCHAR(10), CEP VARCHAR(10), 
				 EMAIL VARCHAR(50), SEXO TEXT, QTD_PRODUTOS BIGINT, 
				 TELEFONE VARCHAR(20), CELULAR VARCHAR(20), DATA_INCLUSAO TIMESTAMPTZ);
*/