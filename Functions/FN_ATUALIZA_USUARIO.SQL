CREATE OR REPLACE FUNCTION
FN_ATUALIZA_USUARIO(P_ID TEXT, P_NOME TEXT, P_CPF VARCHAR(14), P_EMAIL VARCHAR(50), P_SEXO VARCHAR(50), 
					P_NASCIMENTO TEXT, P_SENHA TEXT, P_LOGIN VARCHAR(50) DEFAULT NULL, 
					P_TELEFONE VARCHAR(20) DEFAULT NULL, P_CELULAR VARCHAR(20) DEFAULT NULL)
RETURNS BOOLEAN AS $$
DECLARE P_DATA_NASCIMENTO DATE;
DECLARE P_ID_USUARIO UUID;
BEGIN
	
	P_ID_USUARIO := UUID(P_ID);
	P_DATA_NASCIMENTO := TO_DATE(P_NASCIMENTO, 'YYYY-MM-DD');
	
	BEGIN
		UPDATE USUARIOS
		SET NOME = P_NOME, EMAIL = P_EMAIL,
		SEXO = P_SEXO, DATA_NASCIMENTO = P_DATA_NASCIMENTO
		WHERE ID_USUARIO = P_ID_USUARIO;
		
	EXCEPTION WHEN OTHERS THEN
		PERFORM FN_REPORT_ERRO('ERRO AO ATUALIZAR NA TABELA USUARIO', SQLSTATE, SQLERRM, 'FN_ATUALIZA_USUARIO', 'USUARIOS', CURRENT_QUERY());
		RETURN FALSE;
	END;
	
	BEGIN		
		UPDATE TELEFONES
		SET TELEFONE = P_TELEFONE, CELULAR = P_CELULAR
		WHERE ID_USUARIO = P_ID_USUARIO;
	
	EXCEPTION WHEN OTHERS THEN
		PERFORM FN_REPORT_ERRO('ERRO AO ATUALIZAR NA TABELA TELEFONES', SQLSTATE, SQLERRM, 'FN_ATUALIZA_USUARIO', 'TELEFONES', CURRENT_QUERY());
		RETURN FALSE;
	END;
	
	/*
	BEGIN
		UPDATE ENDERECO
		SET LOGRADOURO = P_LOGRADOURO, NUMERO = P_NUMERO,
		CEP = P_CEP, ID_CIDADE = P_ID_CIDADE
		WHERE ID_USUARIO = P_ID_USUARIO;
	
	EXCEPTION WHEN OTHERS THEN
		PERFORM FN_REPORT_ERRO('ERRO AO ATUALIZAR NA TABELA ENDERECO', SQLSTATE, SQLERRM, 'FN_ATUALIZA_USUARIO', 'ENDERECO', CURRENT_QUERY());
		RETURN FALSE;
	END;
	*/
	BEGIN
		UPDATE AUTENTIFICACAO
		SET LOGIN = P_LOGIN
		WHERE ID_USUARIO = P_ID_USUARIO;
		
	EXCEPTION WHEN OTHERS THEN
		PERFORM FN_REPORT_ERRO('ERRO AO ATUALIZAR NA TABELA AUTENTIFICACAO', SQLSTATE, SQLERRM, 'FN_ATUALIZA_USUARIO', 'AUTENTIFICACAO', CURRENT_QUERY());
		RETURN FALSE;
	END;
		
	RETURN TRUE;
	
	EXCEPTION WHEN OTHERS THEN
		PERFORM FN_REPORT_ERRO('ERRO AO ATUALIZAR USUARIO', SQLSTATE, SQLERRM, 'FN_ATUALIZA_USUARIO', NULL, CURRENT_QUERY());
		RETURN FALSE;
END;
$$ LANGUAGE PLPGSQL;

/*
SELECT FN_ATUALIZA_USUARIO(
'8c94f74e-6811-457c-8a8e-0434c1efa5cb', 'Mais um pra confirmar', 'Rua testando update',
'd93d6170-5ecf-4c2c-95ff-cc75a12aeebb', '145', '87654321','testefunçãoupdate@laugoapp.com', 
'tonho','Masculino', null, null, '2020-05-01')
*/