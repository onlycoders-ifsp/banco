CREATE OR REPLACE FUNCTION FN_RETORNA_USUARIO(P_ID_USUARIO UUID DEFAULT NULL)
RETURNS SETOF RECORD AS $$
DECLARE
BEGIN
		RETURN QUERY SELECT U.NOME, U.CPF, U.EMAIL, U.SEXO,
		T.TELEFONE, T.CELULAR, U.DATA_INCLUSAO, E.ESTADO, E.CIDADE,		
		E.LOGRADOURO, E.NUMERO, E.BAIRRO
		FROM USUARIOS U
		LEFT JOIN TELEFONES T
		ON T.ID_USUARIO = U.ID_USUARIO
		LEFT JOIN ENDERECO E
		ON E.ID_USUARIO = U.ID_USUARIO
		WHERE (U.ID_USUARIO = P_ID_USUARIO OR P_ID_USUARIO IS NULL)
		AND U.ISDELETADO = FALSE;
		
		EXCEPTION WHEN OTHERS THEN
			PERFORM FN_REPORT_ERRO('ERRO AO SELECIONA USUARIO', SQLSTATE, SQLERRM, 'FN_RETORNA_USUARIO', 'USUARIOS/TELEFONES/ENDERECO', CURRENT_QUERY());
	RETURN;
END;
$$ LANGUAGE PLPGSQL;

/* SEM PARAMENTRO RETORNA TUDO
SELECT *FROM FN_RETORNA_USUARIO('8c94f74e-6811-457c-8a8e-0434c1efa5cb') -- OU SELECT *FROM FN_RETORNA_USUARIO()
			AS T(NOME TEXT, CPF VARCHAR(14), EMAIL VARCHAR(50), 
				 SEXO VARCHAR(50), QTD_PRODUTOS BIGINT, TELEFONE VARCHAR(20),
				 CELULAR VARCHAR(20), DATA_INCLUSAO TIMESTAMPTZ,
				PAIS VARCHAR(50), ESTADO CHAR(2), CIDADE VARCHAR(50), 
				LOGRADOURO TEXT, NUMERO VARCHAR(20), BAIRRO VARCHAR(50));
*/