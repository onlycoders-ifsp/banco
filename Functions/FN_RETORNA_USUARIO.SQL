CREATE OR REPLACE FUNCTION FN_RETORNA_USUARIO(P_ID_USUARIO TEXT DEFAULT NULL)
RETURNS SETOF RECORD AS $$
DECLARE
BEGIN

	IF P_ID_USUARIO = '0' THEN 
		P_ID_USUARIO = NULL;
	END IF;
	
	RETURN QUERY SELECT 
	CAST(U.ID_USUARIO AS TEXT),
	CAST(U.NOME AS TEXT), 
	CAST(U.CPF AS TEXT), 
	CAST(U.EMAIL AS TEXT), 
	CAST(U.SEXO AS TEXT), 
	CAST(U.DATA_NASCIMENTO  AS TEXT), 
	CAST(T.TELEFONE AS TEXT), 
	CAST(T.CELULAR AS TEXT), 
	TO_CHAR(U.DATA_INCLUSAO, 'YYYY-MM-DD'),
	CAST(E.ESTADO AS TEXT), 
	CAST(E.CIDADE AS TEXT),	
	CAST(E.LOGRADOURO AS TEXT), 
	CAST(E.NUMERO AS TEXT), 
	CAST(E.BAIRRO AS TEXT)
	FROM USUARIOS U
	LEFT JOIN TELEFONES T
	ON T.ID_USUARIO = U.ID_USUARIO
	LEFT JOIN ENDERECO E
	ON E.ID_USUARIO = U.ID_USUARIO
	WHERE (U.ID_USUARIO = UUID(P_ID_USUARIO) OR P_ID_USUARIO IS NULL)
	AND NOT U.IS_DELETADO;
	
	EXCEPTION WHEN OTHERS THEN
		PERFORM FN_REPORT_ERRO('ERRO AO SELECIONAR USUARIO', SQLSTATE, SQLERRM, 'FN_RETORNA_USUARIO', 'USUARIOS/TELEFONES/ENDERECO', CURRENT_QUERY());
	RETURN;
END;
$$ LANGUAGE PLPGSQL;

/* SEM PARAMENTRO RETORNA TUDO
SELECT *FROM FN_RETORNA_USUARIO('8c94f74e-6811-457c-8a8e-0434c1efa5cb') -- OU SELECT *FROM FN_RETORNA_USUARIO()
			AS T(NOME TEXT, CPF TEXT, EMAIL TEXT, 
				 SEXO TEXT,  DATA_NASCIMENTO TEXT,
				 TELEFONE TEXT, CELULAR TEXT, DATA_INCLUSAO TEXT,
				 ESTADO TEXT, CIDADE TEXT, 
				 LOGRADOURO TEXT, NUMERO TEXT, BAIRRO TEXT);
*/