CREATE OR REPLACE FUNCTION FN_RETORNA_USUARIO(P_ID_USUARIO TEXT DEFAULT NULL, P_USUARIO TEXT DEFAULT '')
RETURNS SETOF RECORD AS $$
DECLARE
BEGIN

	IF P_ID_USUARIO = '0' THEN 
		P_ID_USUARIO := NULL;
	END IF;
	
	RETURN QUERY SELECT 
	CAST(U.ID_USUARIO AS TEXT),
	CAST(U.NOME AS TEXT),
	CAST(U.EMAIL AS TEXT),
	CAST(A.LOGIN AS TEXT),
	CAST(U.CPF AS TEXT),
	CAST(U.CELULAR AS TEXT),
	CAST(U.DATA_NASCIMENTO  AS TEXT), 	
	CAST(U.CEP AS TEXT),
	CAST(U.ENDERECO AS TEXT), 
	CAST(U.COMPLEMENTO AS TEXT),
	CAST(U.BAIRRO AS TEXT),
	CAST(U.NUMERO AS TEXT),
	U.ATIVO,
	U.CAPA_FOTO,
	CAST((SELECT FN_RETORNA_MEDIA_AVALIACAO(U.ID_USUARIO,2)) AS DECIMAL(2,1)) LocatarioAvalicao,
	CAST((SELECT FN_RETORNA_MEDIA_AVALIACAO(U.ID_USUARIO,3)) AS DECIMAL(2,1)) LocadorAvalicao,
	CAST((SELECT FN_RETORNA_MEDIA_AVALIACAO(U.ID_USUARIO,4)) AS DECIMAL(2,1)) ProdutoAvalicao
	FROM USUARIOS U
	LEFT JOIN AUTENTIFICACAO A
	ON A.ID_USUARIO = U.ID_USUARIO
	WHERE ((CAST(U.ID_USUARIO AS TEXT) = P_ID_USUARIO OR A.LOGIN = P_ID_USUARIO)
	OR P_ID_USUARIO IS NULL);
	--AND NOT U.ATIVO; 
	
	EXCEPTION WHEN OTHERS THEN
		PERFORM FN_REPORT_ERRO('ERRO AO SELECIONAR USUARIO', SQLSTATE, SQLERRM, 'FN_RETORNA_USUARIO', 'USUARIOS/TELEFONES/ENDERECO', CURRENT_QUERY(), P_USUARIO);
	RETURN;
END;
$$ LANGUAGE PLPGSQL;