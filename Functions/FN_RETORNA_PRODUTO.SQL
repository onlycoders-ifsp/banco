CREATE OR REPLACE FUNCTION FN_RETORNA_PRODUTO(P_ID_USUARIO TEXT, P_ID_PRODUTO TEXT, OP INT)
RETURNS SETOF RECORD AS $$
BEGIN
	 
	IF P_ID_USUARIO = '0' THEN 
		P_ID_USUARIO := NULL;
	END IF;
	
	IF P_ID_PRODUTO = '0' THEN 
		P_ID_PRODUTO := NULL;
	END IF;
	
	RETURN QUERY 
		SELECT 
		CAST(U.ID_USUARIO AS TEXT),
		CAST(P.ID_PRODUTO AS TEXT),
		CAST(P.NOME AS TEXT),
		CAST(P.DESCRICAO_CURTA AS TEXT),
		CAST(P.DESCRICAO AS TEXT),
		CAST(P.VALOR_BASE_DIARIA AS DECIMAL(16,2)),
		CAST(P.VALOR_BASE_MENSAL AS DECIMAL(16,2)), 
		CAST(P.VALOR_PRODUTO AS DECIMAL(16,2)),
		TO_CHAR(P.DATA_COMPRA,'YYYY-MM-DD'),
		CAST(CASE 
			WHEN AA.QtdAlugueis IS NULL THEN 0 
			ELSE AA.QtdAlugueis
		END AS NUMERIC(16)),
		CAST(CASE
			WHEN AA.TotalGanhos IS NULL THEN 0
			ELSE AA.TotalGanhos
		END AS DECIMAL(16,2)),
		CAST (CASE
			WHEN AV.MEDIAAVALIACAO IS NULL THEN 0
			ELSE AV.MEDIAAVALIACAO
		END AS DECIMAL(6,1)),
		(SELECT FN_RETORNA_ALUGUEIS_EFTUADOS(P.ID_PRODUTO)) DT_ALUGADAS,
		P.CAPA_FOTO,
		P.ATIVO
		FROM PRODUTOS P
		INNER JOIN USUARIOS U
		ON P.ID_USUARIO = U.ID_USUARIO
		LEFT JOIN (SELECT A.ID_PRODUTO, COUNT(1) QtdAlugueis, SUM(A.VALOR_DEBITO) TotalGanhos
						FROM ALUGUEIS A
						GROUP BY A.ID_PRODUTO) AA
		ON AA.ID_PRODUTO = P.ID_PRODUTO
		LEFT JOIN (SELECT ID_PRODUTO, (SUM(NOTA)/(COUNT(1))) MEDIAAVALIACAO 
					FROM AVALIACOES
					GROUP BY ID_PRODUTO) AV
		ON AV.ID_PRODUTO = P.ID_PRODUTO
		WHERE ((P_ID_PRODUTO IS NULL AND U.ID_USUARIO = UUID(P_ID_USUARIO)) AND OP = 1)
			   OR ((CAST(U.ID_USUARIO AS TEXT) = P_ID_USUARIO) AND CAST(P.ID_PRODUTO AS TEXT) = P_ID_PRODUTO AND OP = 2)
			   OR ((P_ID_USUARIO IS NULL AND CAST(P.ID_PRODUTO AS TEXT) = P_ID_PRODUTO) OR LOWER(P.NOME) LIKE CONCAT('%',LOWER(P_ID_PRODUTO),'%') AND OP = 3)
			   OR ((CASE WHEN P_ID_USUARIO IS NULL THEN '0' ELSE P_ID_USUARIO END <> CAST(P.ID_USUARIO AS TEXT)) AND OP = 4)
		ORDER BY ID_USUARIO;

	EXCEPTION WHEN OTHERS THEN
		PERFORM FN_REPORT_ERRO('ERRO AO SELECIONAR PRODUTO', SQLSTATE, SQLERRM, 'FN_RETORNA_PRODUTO', 'PRODUTOS/USUARIOS', CURRENT_QUERY());

END;
$$ LANGUAGE PLPGSQL;