CREATE OR REPLACE FUNCTION FN_RETORNA_USUARIO_PRODUTO(P_ID_USUARIO TEXT DEFAULT NULL, P_ID_PRODUTO TEXT DEFAULT NULL)
RETURNS SETOF RECORD AS $$
--DECLARE DADOS JSON;
BEGIN
	 
	IF P_ID_USUARIO = '0' THEN 
		P_ID_USUARIO = NULL;
	END IF;
	
	IF P_ID_PRODUTO = '0' THEN 
		P_ID_PRODUTO = NULL;
	END IF;
	
	RETURN QUERY 
		SELECT 
		CAST(U.ID_USUARIO AS TEXT), 
		CAST(P.ID_PRODUTO AS TEXT),
		CAST(P.NOME AS TEXT),
		CAST(P.DESCRICAO AS TEXT),
		CAST(P.VALOR_BASE_DIARIA AS DECIMAL(16,2)),
		CAST(P.VALOR_BASE_MENSAL AS DECIMAL(16,2)), 
		CAST(P.VALOR_PRODUTO AS DECIMAL(16,2)),
		TO_CHAR(P.DATA_COMPRA,'YYYY-MM-DD')
		--TO_CHAR(P.DATA_INLUSAO,'YYYY-MM-DD')
		FROM PRODUTOS P
		INNER JOIN USUARIOS U
		ON P.ID_USUARIO = U.ID_USUARIO
		WHERE ((U.ID_USUARIO = UUID(P_ID_USUARIO) OR P_ID_USUARIO IS NULL) AND P_ID_PRODUTO IS NULL)
		OR ((P.ID_PRODUTO = UUID(P_ID_PRODUTO) OR P_ID_PRODUTO IS NULL) AND P_ID_USUARIO IS NULL);
		--AND NOT P.ISDELETADO;

	EXCEPTION WHEN OTHERS THEN
		--DADOS := (SELECT ROW_TO_JSON(a) FROM (SELECT P_ID_USUARIO) A);
		PERFORM FN_REPORT_ERRO('ERRO AO SELECIONAR PRODUTO', SQLSTATE, SQLERRM, 'FN_RETORNA_PRODUTO', 'PRODUTOS/USUARIOS', CURRENT_QUERY());

END;
$$ LANGUAGE PLPGSQL;

/* SEM PARAMENTRO RETORNA TUDO
SELECT *FROM FN_RETORNAR_PRODUTO() -- OU SELECT *FROM FN_RETORNAR_PRODUTO('fc638b3d-cdec-4a94-9177-2d583effec33')
			AS T(NOME_USUARIO TEXT, ID_PRODUTO TEXT, NOME_PRODUTO TEXT, DESCRICAO TEXT, BASE_DIARIA DECIMAL(16,2), 
				 BASE_MENSAL DECIMAL(16,2), VALOR_PRODUTO DECIMAL(16,2), DATA_COMPRA TEXT, DATA_INLUSAO TEXT);
*/